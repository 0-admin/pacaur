#!/bin/bash

#
# pacaur: a fast workflow AUR helper using cower as backend
#

version="3.4.7"

#
# Config
#

# avoid locale issues
export LC_ALL=C

# source makepkg variables
source /etc/makepkg.conf
[[ -r "$HOME/.makepkg.conf" ]] && source "$HOME/.makepkg.conf"

# set variables
tmpdir="${TMPDIR:-/tmp}/pacaurtmp-$USER"    # temp directory
builddir="${BUILDDIR:-$tmpdir}"             # build directory
editor="${EDITOR:-vi}"                      # PKGBUILD editor
editpkgbuild=true                           # edit PKGBUILD
editinstall=true                            # edit install script
fallback=true                               # pacman fallback to the AUR
clean=true                                  # cleanup after install
cleandevel=true                             # cleanup devel after install
color=false                                 # color support via pacman-color
secure=false                                # enhanced security

# source xdg config
if [[ -n "${XDG_CONFIG_DIRS}" ]]; then
    xdg_config=($(awk -F ":" '{for (i=1; i<=NF; i++) print $i}' <<< ${XDG_CONFIG_DIRS}))
    for i in "${xdg_config[@]}"; do
        [[ -d "$i" ]] && export XDG_CONFIG_DIRS="$i" && break
    done
fi
configdir="${XDG_CONFIG_DIRS:-/etc/xdg}/pacaur"
userconfigdir="${XDG_CONFIG_HOME:-${HOME}/.config}/pacaur"
source "$configdir/config"
[[ -r "$userconfigdir/config" ]] && source "$userconfigdir/config"

# color
if $color; then
    pacmanbin='pacman-color'
    cower='cower --color=auto'
    reset="\e[0m"
    colorR="\e[1;31m"
    colorG="\e[1;32m"
    colorY="\e[1;33m"
    colorB="\e[1;34m"
    colorM="\e[1;35m"
    colorC="\e[1;36m"
    colorW="\e[1;39m"
else
    pacmanbin='pacman'
    cower='cower'
fi

# alternative pacman binary
[[ $PACMAN ]] && pacmanbin=$PACMAN

# set up directories
[[ -d "$tmpdir" ]] && [[ ! -w "$tmpdir" ]] && sudo rm -rf "$tmpdir"
[[ ! -d "$tmpdir" ]] && mkdir -p "$tmpdir"
[[ ! -d "$builddir" ]] && mkdir -p "$builddir"

#
# Functions
#

ClassifyPkgs() {
    if [[ $fallback = true ]]; then
        [[ $repo ]] && repopkgs=("${pkgs[@]}")
        [[ $aur ]] && aurpkgs=("${pkgs[@]}")
        if [[ ! $repo && ! $aur ]]; then
            getignoredgrps
            for i in "${pkgs[@]}"; do
                [[ " ${ignoredgrps[@]} " =~ " $i " ]] && repopkgs+=("$i") && continue
                [[ -z "$(expac -S '%n' "$i" || expac -Sg '%n' "$i")" ]] && aurpkgs+=("$i") || repopkgs+=("$i")
            done
        fi
    else
        [[ ! $aur ]] && repopkgs=("${pkgs[@]}") || aurpkgs=("${pkgs[@]}")
    fi
}

Core() {
    getignoredpkgs
    [[ $upgrade ]] && UpgradeAur
    IgnoreChecks
    DownloadPkgs
    IgnoreDepsChecks
    ProviderChecks
    ConflictChecks
    ReinstallChecks
    OutofdateChecks
    Prompt
    MakePkgs
}

UpgradeAur() {
    msg "i" "${colorW}Starting AUR upgrade...${reset}"
    aurpkgs+=($($cower -uq ${pkgs[@]} ${ignoreopts[@]}))
    aurpkgs=($(sort -u <<< ${aurpkgs[@]}))

    # check foreign packages
    allforeignpkgs=($($pacmanbin -Qmq))
    downloadjson ${allforeignpkgs[@]}
    allaurpkgs=($(getjsonvar "Name"))
    foreignpkgs=($(comm -23 <(echo "${allforeignpkgs[@]}" | sed 's/ /\n/g') <(echo "${allaurpkgs[@]}" | sed 's/ /\n/g')))
    for i in "${foreignpkgs[@]}"; do
        msg "w" "${colorW}$i${reset} is ${colorY}not present${reset} in AUR -- skipping"
    done

    # add devel packages
    if [[ $devel ]]; then
        allaurpkgsQver=($(expac -Q '%v' "${allaurpkgs[@]}"))
        allaurpkgsurl=($(getjsonvar "URLPath"))
        for ((i=0; i<${#allaurpkgs[@]}; i++)); do
            downloadpkgbuild "${allaurpkgs[$i]}" "${allaurpkgsurl[$i]}" &
            paraexec
        done
        wait
        for ((i=0; i<${#allaurpkgs[@]}; i++)); do
            if isdevel "$tmpdir/${allaurpkgs[$i]}.PKGBUILD"; then
                if [[ " ${ignoredpkgs[@]} " =~ " ${allaurpkgs[$i]} " ]]; then
                    msg "w" "${colorW}${allaurpkgs[$i]} ${colorY}${allaurpkgsQver[$i]}${reset}: ignoring package upgrade"
                    continue
                else
                    aurpkgs+=("${allaurpkgs[$i]}")
                fi
            fi
        done
    fi

    nothingtodo ${aurpkgs[@]}
    timeout ${aurpkgs[@]}
}

IgnoreChecks() {
    [[ -z "${ignoredpkgs[@]}" ]] && return

    checkaurpkgs=("${aurpkgs[@]}")
    unset aurpkgs

    # check targets
    for i in "${checkaurpkgs[@]}"; do
        if [[ " ${ignoredpkgs[@]} " =~ " $i " ]]; then
            if [[ ! $upgrade && ! $noconfirm ]]; then
                if ! proceed "y" "${colorY}::${reset} $i is in IgnorePkg/IgnoreGroup. Install anyway?"; then
                    msg "w" "${colorW}$i${reset}: ignoring package upgrade"
                    continue
                fi
            else
                continue
            fi
        fi
        aurpkgs+=("$i")
    done

    nothingtodo ${aurpkgs[@]}
}

DownloadAur() {
    while read -r flag pkg info; do
        case $flag in
            S)  [[ $operation = download ]] && echo "$info"; [[ -n "$info" ]] && deps+=("$pkg");;
            W)  [[ $operation = download ]] && echo "$info" || continue;;
            E)  echo "$info";;
        esac
    done < <($cower ${coweropts[@]} -db $@ ${ignoreopts[@]} -t $builddir --color=always 2>&1)

    # check PKGBUILDs
    for i in "${deps[@]}"; do
        [[ -e "$builddir/$i/PKGBUILD" ]] && continue || msg "e" "Could not read ${colorW}$i${reset} PKGBUILD: badly packaged tarball"
    done

    timeout ${deps[@]}
}

DownloadPkgs() {
    if [[ $secure = true ]]; then
        if [[ $operation = download && $count -lt 2 ]]; then
            DownloadAur ${aurpkgs[@]} && return
        else
            msg "i" "resolving dependencies..."
            coweropts+=("-d") && DownloadAur ${aurpkgs[@]} # recursive here
        fi
        # check for CARCH 32/64bits bash magic
        for i in "${deps[@]}"; do
            [[ -n "$(grep 'CARCH' "$builddir/$i/PKGBUILD")" ]] && msg "e" "${colorW}\$CARCH${reset} variable detected. ${colorW}$i${reset} requires the full bash dependency solver to be enabled with the --insecure option."
        done
    else
        msg "i" "resolving dependencies..."
        allaurdeps+=("${aurpkgs[@]}")
        FindPkgsDeps ${aurpkgs[@]}
        deps=("${allaurdeps[@]}")
        # reduce root binary deps
        repodeps=($(sort -u <<< ${repodeps[@]}))
    fi

    # return AUR deps pkgs only
    aurdepspkgs=(${deps[@]:${#aurpkgs[@]}:${#deps[@]}})

    # return binary deps
    if [[ -n "${repodeps[@]}" ]]; then
        for i in "${repodeps[@]}"; do
            allrepopkgs+=($(pactree -su "$i"))
        done
        repodepspkgs=($($pacmanbin -T "${allrepopkgs[@]}" | sort -u))
    fi

    # get version numbers
    downloadjson ${deps[@]}
    depsAver=($(getjsonvar "Version")) # return sorted results
    depsAood=($(getjsonvar "OutOfDate"))
    depsbuild=("${deps[@]}") && deps=($(sort -u <<< ${deps[@]}))
    for i in "${deps[@]}"; do
        Qver=$(expac -Q '%v' "$i")
        [[ -n "$Qver" ]] && depsQver+=("$Qver") || depsQver+=("")
    done
    if [[ -n "${repodepspkgs[@]}" ]]; then
        repodepsSver=($(expac -S -1 '%v' "${repodepspkgs[@]}"))
        repodepsQver=($(expac -Q '%v' "${repodepspkgs[@]}"))
    fi
}

FindPkgsDeps() {
    [[ -z "${depspkgsaur[@]}" ]] && depspkgsaur=("${aurpkgs[@]}")

    DownloadAur ${depspkgsaur[@]}
    [[ $operation = download && $count -lt 2 ]] && return

    # source pkgs
    for i in "${deps[@]}"; do
        # preview before sourcing
        PreviewPkgs $i
        source <(awk '/^build.*(.*)|^package.*(.*)/{exit};1' "$builddir/$i/PKGBUILD") && sourcedpkgs+=(${depends[*]} ${makedepends[*]})
    done

    # remove installed deps
    depspkgs=($($pacmanbin -T "${sourcedpkgs[@]}"))

    # split binary and AUR depends pkgs
    [[ -e "$tmpdir/aurdeps" ]] && rm "$tmpdir/aurdeps"
    [[ -n "${depspkgs[@]}" ]] && depspkgsrepo=($(expac -S -1 -v '%n' "${depspkgs[@]}" 2>"$tmpdir/aurdeps")) && repodeps+=(${depspkgsrepo[@]})
    [[ -e "$tmpdir/aurdeps" ]] && depspkgsaur=($(grep 'error:' "$tmpdir/aurdeps" | awk -F "\`" '{print $2}' | awk -F "'" '{print $1}')) || unset depspkgsaur
    unset deps sourcedpkgs depends makedepends depspkgs

    if [[ -n "${depspkgsaur[@]}" ]]; then
        # remove AUR package versioning
        local j=0
        for i in "${depspkgsaur[@]}"; do
            depspkgsaur[$j]=$(awk -F ">|<|=" '{print $1}' <<< $i)
            ((j++))
        done
        for i in "${depspkgsaur[@]}"; do
            [[ " ${allaurdeps[@]} " =~ " $i " ]] && continue || allaurdeps+=("$i")
        done
        FindPkgsDeps ${depspkgsaur[@]}
    fi
}

PreviewPkgs() {
    # sanitize for sudo security check
    cp "$builddir/$i/PKGBUILD" "$builddir/$i/PKGBUILD.sudocheck"
    while [[ -n "$(grep -Po '^depends=\([^)].*[^)]$|^optdepends=\([^)].*[^)]$' "$builddir/$i/PKGBUILD.sudocheck")" ]] ; do
        sed -i -e '/^depends=*[^)]/N' -e 's/\n//' "$builddir/$i/PKGBUILD.sudocheck"
        sed -i -e '/^optdepends=*[^)]/N' -e 's/\n//' "$builddir/$i/PKGBUILD.sudocheck"
    done

    [[ -n "$(grep -w 'sudo' "$builddir/$i/PKGBUILD.sudocheck" | grep -Ev '^depends|^optdepends')" ]] && msg "w" "Potentially dangerous '${colorR}sudo${reset}' detected in ${colorW}$i${reset}" && EditPkgs $i || return
    if [[ ! $noconfirm ]]; then
        if proceed "n" "${colorY}::${reset} Do you ${colorW}really${reset} want to continue?"; then
            CleanUp ${deps[@]} &>/dev/null
            exit
        fi
    fi
}

IgnoreDepsChecks() {
    [[ -z "${ignoredpkgs[@]}" ]] && return
    unset depsbuild

    # add checked targets
    depsbuild+=("${aurpkgs[@]}")

    # check dependencies
    for i in "${repodepspkgs[@]}"; do
        if [[ " ${ignoredpkgs[@]} " =~ " $i " ]]; then
            msg "w" "${colorW}$i${reset}: ignoring package upgrade"
            CleanUp ${aurpkgs[@]} &>/dev/null
            CleanUp ${aurdepspkgs[@]} &>/dev/null
            msg "e" "Unresolved dependency '${colorW}$i${reset}'"
        fi
    done
    for i in "${aurdepspkgs[@]}"; do
        if [[ " ${ignoredpkgs[@]} " =~ " $i " ]]; then
            if [[ ! $noconfirm ]]; then
                if ! proceed "y" "${colorY}::${reset} $i dependency is in IgnorePkg/IgnoreGroup. Install anyway?"; then
                    CleanUp ${aurpkgs[@]} &>/dev/null
                    CleanUp ${aurdepspkgs[@]} &>/dev/null
                    msg "e" "Unresolved dependency '${colorW}$i${reset}'"
                fi
            else
                msg "w" "${colorW}$i${reset}: ignoring package upgrade"
                CleanUp ${aurpkgs[@]} &>/dev/null
                CleanUp ${aurdepspkgs[@]} &>/dev/null
                msg "e" "Unresolved dependency '${colorW}$i${reset}'"
            fi
        fi
        depsbuild+=("$i")
    done
}

ProviderChecks() {
    [[ -z "${repodepspkgs[@]}" ]] && return
    allproviders=($(expac -S '%P' "${repodepspkgs[@]}" | uniq))

    for ((i=0; i<${#allproviders[@]}; i++)); do
        providers=($(expac -Ss '%n' "^${allproviders[$i]}$"))
        [[ ! ${#providers[@]} -gt 1 ]] && continue

        # skip if already provided
        for j in "${providerpkgs[@]}"; do
            provided+=($(expac -S '%P' "$j"))
        done
        [[ -n "${provided[@]}" ]] && [[ " ${provided[@]} " =~ " ${allproviders[$i]} " ]] && continue

        if [[ ! $noconfirm ]]; then
            msg "i" "${colorW} There are ${#providers[@]} providers available for ${allproviders[$i]}:${reset}"
            expac -S -1 '   %!) %n (%r) ' "${providers[@]}"

            local nb=-1
            while [[ $nb -lt 0 || $nb -ge ${#providers} ]]; do

                echo -e -n "\nEnter a number (default=0):"
                nbchar=$(wc -l <<< ${#providers[@]})
                read -n ${#nbchar} nb
                echo ""

                case $nb in
                    [0-9]) [[ $nb -lt 0 || $nb -ge ${#providers[@]} ]] && echo -e "\n${colorR}::${reset} invalid value: $nb is not between 0 and ${#providers[@]}" && ((i--)) || break;;
                    '') nb=0;;
                    *) echo -e "${colorR}::${reset} invalid number: $nb";;
                esac

            done
        else
            local nb=0
        fi
        providerpkgs+=(${providers[$nb]})
   done
}

ConflictChecks() {
    msg "i" "looking for inter-conflicts..."
    if [[ ! $noconfirm ]]; then
        local k=0
        for i in "${deps[@]}"; do
            unset conflicts
            conflicts=("$(grep "^conflicts=" "$builddir/$i/PKGBUILD" | cut -d '=' -f2 | tr -d "'\"()")")
            [[ -z "${conflicts[@]}" ]] && conflicts=($(expac -Q '%n' "$i")) || [[ -n "${conflicts[@]}" ]] && conflicts=($(expac -Q '%n' "${conflicts[@]}"))
            # return when no conflict
            [[ " ${conflicts[@]} " =~ " $i " ]] && continue || conflictspkgs=("${conflicts[@]}")

            for j in "${conflictspkgs[@]}"; do
                if [[ $j = $i ]]; then
                    continue
                else
                    if ! proceed "n" "${colorB}::${reset} ${colorW}$i and $j are in conflict. Remove $j?${reset}"; then
                        break
                    else
                        [[ " ${pkgs[@]} " =~ " $i " ]] && unset deps[$k] || msg "e" "failed to prepare transaction (conflicting dependencies)"
                    fi
                fi
            done
            ((k++))
        done
    fi

    nothingtodo ${deps[@]}
}

ReinstallChecks() {
    for ((i=0; i<${#deps[@]}; i++)); do
        [[ ! " ${aurpkgs[@]} " =~ " ${deps[$i]} " ]] && continue
        [[ $(vercmp "${depsAver[$i]}" "${depsQver[$i]}") -gt 0 ]] && continue
        if [[ ! $needed ]]; then
            msg "w" "${deps[$i]}-${depsQver[$i]} is up to date -- reinstalling"
        else
            msg "w" "${deps[$i]}-${depsQver[$i]} is up to date -- skipping"
            depsbuild=(${depsbuild[@]/${deps[$i]}/})
            unset deps[$i] depsQver[$i] depsAver[$i] depsAood[$i]
        fi
    done
    # remove empty elements
    [[ $needed ]] && deps=(${deps[@]}) && depsQver=(${depsQver[@]}) && depsAver=(${depsAver[@]}) && depsAood=(${depsAood[@]})

    nothingtodo ${deps[@]}
}

OutofdateChecks() {
    for ((i=0; i<${#deps[@]}; i++)); do
        [[ "${depsAood[$i]}" -gt 0 ]] && msg "w" "${colorW}${deps[$i]}${reset} has been flagged ${colorR}out of date${reset} on ${colorY}$(date -d "@${depsAood[$i]}" "+%Y-%m-%d")${reset}"
    done
}

Prompt() {
    # compute binary size
    if [[ -n "${repodepspkgs[@]}" ]]; then
        binaryksize=($(expac -S -1 "%k" "${repodepspkgs[@]}"))
        binarymsize=($(expac -S -1 "%m" "${repodepspkgs[@]}"))
        sumk=0
        summ=0
        for ((i=0; i<${#repodepspkgs[@]}; i++)); do
            getcachedpkg "${repodepspkgs[$i]}-${repodepsSver[$i]}" '/var/cache/pacman/pkg'
            [[ $cachedpkg ]] && binaryksize=(${binaryksize[@]/${binaryksize[$i]}/0})
            sumk=$(($sumk + ${binaryksize[$i]}))
            summ=$(($summ + ${binarymsize[$i]}))
        done
        sumk=$(awk '{ printf("%.2f\n", $1/$2) }' <<< "$sumk 1048576")
        summ=$(awk '{ printf("%.2f\n", $1/$2) }' <<< "$summ 1048576")
    fi

    if [[ -n "$(grep '^VerbosePkgLists' '/etc/pacman.conf')" ]]; then
        # compute table length
        lengthn=("${deps[@]}" "${repodepspkgs[@]}")
        lengthv=("${depsQver[@]}" "${depsAver[@]}" "${repodepsQver[@]}" "${repodepsSver[@]}")
        lname=0
        for i in "${lengthn[@]}"; do
            x=${#i}
            [[ $x -gt $lname ]] && lname=$x
        done
        lver=0
        for i in "${lengthv[@]}"; do
            x=${#i}
            [[ $x -gt $lver ]] && lver=$x
        done
        [[ $lname -gt 4 ]] && lname=$(($lname+2)) || lname=6
        [[ $lver -gt 10 ]] && lver=$(($lver+2)) || lver=12

        # show detailed output
        printf "\n${colorY}%s${reset}\n\n" "AUR Targets  (${#deps[@]}):"
        printf "${colorW}%-${lname}s %-${lver}s %-${lver}s${reset}\n\n" "Name" "Old Version" "New Version"
        for ((i=0; i<${#deps[@]}; i++)); do
            printf "%-${lname}s ${colorR}%-${lver}s${reset} ${colorG}%-${lver}s${reset}\n" "${deps[$i]}" "${depsQver[$i]}" "${depsAver[$i]}";
        done

        if [[ -n "${repodepspkgs[@]}" ]]; then
            printf "\n${colorY}%s${reset}\n\n" "Repo Targets (${#repodepspkgs[@]}):"
            printf "${colorW}%-${lname}s %-${lver}s %-${lver}s %s${reset}\n\n" "Name" "Old Version" "New Version" "Download Size"
            for ((i=0; i<${#repodepspkgs[@]}; i++)); do
                printf "%-${lname}s ${colorR}%-${lver}s${reset} ${colorG}%-${lver}s${reset} %13s\n" "${repodepspkgs[$i]}" "${repodepsQver[$i]}" "${repodepsSver[$i]}" "$(awk '{ printf("%.2f\n", $1/$2) }' <<< "${binaryksize[$i]} 1048576") MiB";
            done
        fi
    else
        # show version
        for ((i=0; i<${#deps[@]}; i++)); do
            depsver="${depsver}${deps[$i]}-${depsAver[$i]}  "
        done
        for ((i=0; i<${#repodepspkgs[@]}; i++)); do
            repodepspkgsver="${repodepspkgsver}${repodepspkgs[$i]}-${repodepsSver[$i]}  "
        done
        printf "\n${colorY}%-17s${reset} %s\n" "AUR Targets  (${#deps[@]}):" "$depsver"
        [[ -n "${repodepspkgs[@]}" ]] && printf "${colorY}%-17s${reset} %s\n" "Repo Targets (${#repodepspkgs[@]}):" "$repodepspkgsver"
    fi

    if [[ -n "${repodepspkgs[@]}" ]]; then
        printf "\n${colorW}%-20s${reset} %11s\n" "Repo Download Size:" "$sumk MiB"
        printf "${colorW}%-20s${reset} %11s\n" "Repo Installed Size:" "$summ MiB"
    fi

    if [[ ! $noconfirm ]]; then
        [[ $installpkg ]] && action="installation" || action="download"
        if ! proceed "y" "\nProceed with $action?"; then
            CleanUp ${deps[@]} &>/dev/null
            exit
        fi
    fi

    EditPkgs ${depsbuild[@]}
}

EditPkgs() {
    [[ $noedit ]] && return
    for i in "$@"; do
        getinstallscript $i
        if [[ ! $edit ]]; then
            # edit pkgbuild
            if [[ ! $editpkgbuild = false ]]; then
                if proceed "y" "${colorB}::${reset} View ${colorW}$i${reset} PKGBUILD?"; then
                    [[ -e "$builddir/$i/PKGBUILD" ]] && $editor "$builddir/$i/PKGBUILD" && msg "s" "${colorW}$i${reset} PKGBUILD viewed" || msg "e" "Could not open ${colorW}$i${reset} PKGBUILD"
                fi
            fi
            # edit install script
            if [[ ! $editinstall = false && -n "$installscript" ]]; then
                if proceed "y" "${colorB}::${reset} View ${colorW}$i${reset} .install script?"; then
                    [[ -e "$builddir/$i/$installscript" ]] && $editor "$builddir/$i/$installscript" && msg "s" "${colorW}$i${reset} install script viewed" || msg "e" "Could not open ${colorW}$i${reset} install script"
                fi
            fi
        else
            [[ -e "$builddir/$i/PKGBUILD" ]] && $editor "$builddir/$i/PKGBUILD" && msg "s" "${colorW}$i${reset} PKGBUILD viewed" || msg "e" "Could not open ${colorW}$i${reset} PKGBUILD"
            if [[ -n "$installscript" ]]; then
                [[ -e "$builddir/$i/$installscript" ]] && $editor "$builddir/$i/$installscript" && msg "s" "${colorW}$i${reset} install script viewed" || msg "e" "Could not open ${colorW}$i${reset} install script"
            fi
        fi
    done
}

MakePkgs() {
    # initialize sudo
    sudo -v

    # reverse deps order
    deps=($(awk -F " " '{for (i=NF;i>=1;i--) print $i}' <<< ${depsbuild[@]} | awk -F "\n" '{print}'))

    # makepkg options
    [[ $color != true ]] && makeopts+=("--nocolor")
    export PACMAN=$pacmanbin

    # check destination folder
    [[ ! $installpkg ]] && [[ ! $PKGDEST ]] && [[ $clean = true ]] && msg "e" "Please set ${colorW}PKGDEST${reset} variable in /etc/makepkg.conf or disable ${colorW}clean${reset} option."

    # install provider packages
    if [[ -n "${providerpkgs[@]}" ]]; then
        msg "i" "Installing ${colorW}${providerpkgs[@]}${reset} dependencies..."
        yes | sudo $pacmanbin -S ${providerpkgs[@]} --asdeps
    fi

    local j=0
    for i in "${deps[@]}"; do
        # check package cache
        unset cachedpkg
        [[ $PKGDEST && ! $rebuild ]] && getcachedpkg "$i-${depsAver[$j]}" "$PKGDEST"
        if [[ $cachedpkg ]]; then
            if [[ $installpkg ]]; then
                msg "i" "Installing ${colorW}$i${reset} cached package..."
                yes | sudo $pacmanbin -U $cachedpkg ${pacopts[@]}
            else
                msg "i" "Package ${colorW}$i${reset} already available in cache"
            fi
        else
            # build
            msg "i" "Building ${colorW}$i${reset} package..."
            cd "$builddir/$i"
            if [[ $installpkg ]]; then
                # install
                yes | makepkg -sfi ${makeopts[@]}
            else
                if [[ " ${aurdepspkgs[@]} " =~ " $i " ]]; then
                    # install AUR deps
                    msg "i" "Installing ${colorW}$i${reset} dependencies..."
                    yes | makepkg -sfi ${makeopts[@]}
                else
                    # install then remove binary deps
                    yes | makepkg -sfr ${makeopts[@]}
                fi
            fi
            # clean
            CleanUp $i
        fi
        # set dep status
        if [[ $installpkg ]]; then
            [[ ! $upgrade ]] && ! [[ " ${pkgs[@]} " =~ " $i " ]] && sudo $pacmanbin -D $i --asdeps ${pacopts[@]} &>/dev/null
            [[ " ${pacopts[@]} " =~ " --asdeps " ]] && sudo $pacmanbin -D $i --asdeps ${pacopts[@]} &>/dev/null
            [[ " ${pacopts[@]} " =~ " --asexplicit " ]] && sudo $pacmanbin -D $i --asexplicit ${pacopts[@]} &>/dev/null
        else
            sudo $pacmanbin -D $i --asdeps ${pacopts[@]} &>/dev/null
        fi
        ((j++))
    done
    # remove AUR deps
    if [[ ! $installpkg && -n "${aurdepspkgs[@]}" ]]; then
        msg "i" "Removing installed AUR dependencies..."
        sudo $pacmanbin -Rsn ${aurdepspkgs[@]} --noconfirm
    fi
}

CleanUp() {
    [[ ! $clean = true ]] && return
    if [[ -n "$@" ]]; then
        cd "$builddir"
        for i in "$@"; do
            if [[ ! $cleandevel = true && $count -lt 2 ]]; then
                if isdevel "$builddir/$i/PKGBUILD"; then
                    msg "w" "${colorW}$i${reset} cleaning skipped"
                    continue
                fi
            else
                # hack for vcs protected files
                chmod -R 755 $i &>/dev/null
                rm -r $i &>/dev/null && msg "s" "${colorW}$i${reset} cleaned" || msg "w" "Could not clean ${colorW}$i${reset}"
            fi
        done
    else
        # hack for vcs protected files
        chmod -R 755 $builddir/* &>/dev/null
        rm -r $builddir/* &>/dev/null && msg "s" "Build directory cleaned" || msg "w" "Build directory already cleaned"
    fi
}

SearchInfoAur() {
    $cower ${coweropts[@]} $@
}

CheckRepo() {
    repopkgsQood=($($pacmanbin -Quq $@))
    if [[ -n "${repopkgsQood[@]}" ]]; then
        repopkgsQver=($(expac -Q '%v' "${repopkgsQood[@]}"))
        repopkgsSver=($(expac -S -1 '%v' "${repopkgsQood[@]}"))
        for ((i=0; i<${#repopkgsQood[@]}; i++)); do
            repopkgsQgrp[$i]=$(expac -Q -l " " '%G' "${repopkgsQood[$i]}")
        done
        local i=0
        for j in "${repopkgsQood[@]}"; do
            [[ -n "${repopkgsQgrp[$i]}" ]] && repopkgsQgrp[$i]="(${repopkgsQgrp[$i]})"
            [[ ! $quiet ]] && msg "i" "${colorW}$j ${colorR}${repopkgsQver[$i]} ${reset}-> ${colorG}${repopkgsSver[$i]}${reset} ${colorB}${repopkgsQgrp[$i]}${reset}" || echo "$j"
            ((i++))
        done
    fi
}

CheckAur() {
    $cower ${coweropts[@]} $@
    # hack to override unconventional cower exit codes
    [[ -z "${pkgs[@]}" ]] && return 0 || expac -Q '%n' "${pkgs[@]}" &>/dev/null
}

CleanCache() {
    if [[ $PKGDEST && $PKGDEST != '/var/cache/pacman/pkg/' ]]; then
        [[ ! $aur ]] && echo ""
        echo -e "${colorW}AUR cache directory:${reset} $PKGDEST"
        if [[ $count -eq 1 ]]; then
            echo -e "${colorW}Packages to keep:${reset}\n  All locally installed packages"
            if ! proceed "y" "Do you want to remove all other packages from AUR cache?"; then
                exit
            fi

            echo "removing old packages from cache..."
            for i in $(ls $PKGDEST | sed "s#\(.*\)-.*#\1#g" ); do
                pkgname=$(sed "s#\(.*\)-.*-.*#\1#g" <<< $i)
                [[ $i != $(expac -Q '%n-%v' "$pkgname") ]] && rm $PKGDEST/$i-*
            done
        else
            if ! proceed "n" "Do you want to remove ALL files from AUR cache?"; then
                echo "removing all files from AUR cache..."
                rm $PKGDEST/* &>/dev/null
            fi
        fi
    fi
}

getignoredgrps() {
    ignoredgrps+=($(grep '^IgnoreGroup' '/etc/pacman.conf' | cut -d '=' -f 2- | tr -d "'\""))
}

getignoredpkgs() {
    ignoredpkgs+=($(grep '^IgnorePkg' '/etc/pacman.conf' | cut -d '=' -f 2- | tr -d "'\""))
    [[ -e "$HOME/.config/cower/config" ]] && ignoredpkgs+=($(grep '^IgnorePkg' "$HOME/.config/cower/config" | cut -d '=' -f 2- | tr -d "'\""))
    ignoredpkgs=(${ignoredpkgs[@]//,/ })
}

getinstallscript() {
    [[ ! -e "$builddir/$1/PKGBUILD" ]] && return
    installscript="$(grep "^install=" "$builddir/$1/PKGBUILD" | cut -d '=' -f 2- | tr -d "'\"")"
    if [[ -n "$(grep -E '\$[{]*pkgname[}]*' <<< $installscript)" ]]; then
        Apkgname=$(grep '^pkgname' "$builddir/$1/PKGBUILD" | cut -d '=' -f 2- | tr -d "'\"")
        installscript=$(sed -e "s/\$[{]*pkgname[}]*/$Apkgname/g" <<< $installscript)
    fi
}

getcachedpkg() {
    cachedpkg="$2/$1-${CARCH}${PKGEXT}"
    [[ ! -f "$cachedpkg" ]] && cachedpkg="$2/$1-any${PKGEXT}"
    [[ ! -f "$cachedpkg" ]] && unset cachedpkg
}

isdevel() {
    [[ -e "$1" ]] && [[ -n "$(grep -E "_(cvsroot|svntrunk|gitroot|hgroot|bzrtrunk|darcstrunk)" "$1")" ]]
}

downloadpkgbuild() {
    curl -sf --compressed "https://aur.archlinux.org${2%/*}/PKGBUILD" -o "$tmpdir/$1.PKGBUILD"
}

downloadjson() {
    arg="$(printf "&arg[]=%s" "$@")"
    url="$(printf "https://aur.archlinux.org/rpc.php?type=multiinfo%s" "$arg")"
    curl -sfg --compressed "$url" -o "$tmpdir/raw.json"
}

getjsonvar() {
    json_reformat < "$tmpdir/raw.json" | tr -d "\" "| grep -Po "$1:.*" | sed -r 's/,//g' | awk -F ":" '{print $2}'
}

proceed() {
    case "$1" in
        y)  echo -ne "$2 [Y/n] "
            read -n 1 answer
            echo ""
            case $answer in
                [Yy]|'') return 0;;
                *) return 1;;
            esac;;
        n)  echo -ne "$2 [y/N] "
            read -n 1 answer
            echo ""
            case $answer in
                [Nn]|'') return 0;;
                *) return 1;;
            esac;;
    esac
}

msg() {
    case "$1" in
        i) echo -e "${colorB}::${reset} $2";;   # info
        s) echo -e "${colorG}::${reset} $2";;   # success
        w) echo -e "${colorY}::${reset} $2";;   # warn
        e) echo -e "${colorR}::${reset} $2";    # error
           exit 1;;
    esac
}

paraexec() {
    while (( $(jobs | wc -l) >= 10 )); do
        sleep 0.1
        jobs > /dev/null
    done
}

nothingtodo() {
    [[ -z "$@" ]] && echo " there is nothing to do" && exit || return 0
}

timeout() {
    [[ -z "$(grep -Ev 'resolve host name|no results found for' <<< $@)" ]] && exit 1 || return 0
}

usage() {
    echo "usage:  pacaur <operation> [options] [package(s)]"
    echo "operations:"
    echo " pacman extension"
    echo "   -S, -Q           extend pacman operations to the AUR"
    echo " AUR only"
    echo "   -s, --search     search AUR repository for matching strings"
    echo "   -i, --info       view package information -- pass twice for details"
    echo "   -d, --download   download target(s) -- pass twice to download AUR dependencies"
    echo "   -m, --makepkg    download and make target(s)"
    echo "   -y, --sync       download, make and install target(s)"
    echo "   -k, --check      check for AUR update(s)"
    echo "   -u, --update     update AUR package(s)"
    echo " general"
    echo "   -v, --version    display version information"
    echo "   -h, --help       display help information"
    echo "   --fixbackend     quickly rebuild backend"
    echo ""
    echo "options:"
    echo " pacman extension - can be used with the -S, -Ss, -Si, -Sii, -Sw, -Su, -Qu, -Sc, -Scc operations"
    echo "   -a, --aur        only search, install or clean packages from the AUR"
    echo "   -r, --repo       only search, install or clean packages from the repositories"
    echo " general"
    echo "   -e, --edit       edit target(s) PKGBUILD and view install script"
    echo "   -c, --clean      clean target(s) build files -- can be combined with the -m, -y, -u operations"
    echo "   -q, --quiet      show less information for query and search"
    echo "   --devel          consider AUR development packages upgrade"
    echo "   --ignore         ignore a package upgrade (can be used more than once)"
    echo "   --noconfirm      do not prompt for any confirmation"
    echo "   --noedit         do not prompt to edit files"
    echo "   --rebuild        always rebuild package(s)"
    echo ""
}

version() {
    echo "pacaur $version"
}

fixbackend() {
    msg "i" "Rebuilding ${colorW}cower${reset} backend..."
    cowerexec=($(expac -Q '%n' "cower")) # cower-git compatibility
    downloadjson $cowerexec
    cowerexecurl=($(getjsonvar "URLPath"))
    downloadpkgbuild "$cowerexec" "$cowerexecurl"
    mkdir -p "$builddir/$cowerexec" && cd "$builddir/$cowerexec"
    makepkg -p $tmpdir/$cowerexec.PKGBUILD -sfic ${makeopts[@]} --noconfirm
    CleanUp $cowerexec
}

#
# Main
#

# get short arguments
args=("$@")
for i in "${args[@]}"; do
    [[ "$i" =~ ^-[a-zA-Z0-9] ]] && opts+=("$i")
done

# get options
count=0
while [[ -n "${!OPTIND}" ]]; do
    while getopts "sidmykufecqrahvVDQRSTUbglnoptw-:" OPT; do
        pacmanarg+=("-$OPT");
        case "$OPT" in
            -)
                case "$OPTARG" in
                    # pacaur
                    search) operation=search; coweropts+=("-s"); aur='1';;
                    info) operation=info; coweropts+=("-i"); aur='1';;
                    download) operation=download; ((count++));;
                    makepkg) operation=sync; coweropts+=("-f"); aur='1';;
                    sync) operation=sync; installpkg=true; coweropts+=("-f"); aur='1';;
                    check) operation=upgrades; coweropts+=("-u"); aur='1';;
                    update) operation=sync; upgrade=true; installpkg=true; coweropts+=("-f"); selective=true; aur='1';;
                    force) coweropts+=("-f"); pacopts+=("--force");;
                    edit) edit=true; [[ ! $pacQ && ! $operation ]] && operation=editpkg;;
                    clean) operation=cleanpkg; clean=true; ((count++));;
                    quiet) quiet=true; pacopts+=("--quiet"); coweropts+=("-q"); coweropts+=("--color=never");;
                    # pacman
                    repo) repo='1';;
                    aur) aur='1';;
                    # others
                    devel) devel=true;;
                    asroot) makeopts+=("--asroot");;
                    ignore) ignoredpkgs+=("${!OPTIND}"); ignoreopts+=("--ignore ${!OPTIND}"); shift;;
                    needed) needed=true; pacopts+=("--needed");;
                    noconfirm) noconfirm=true; pacopts+=("--noconfirm");;
                    noedit) noedit=true;;
                    rebuild) rebuild=true;;
                    insecure) secure=false;;
                    fixbackend|allanbrokeit) fixbackend; exit;;
                    version) version; exit;;
                    help) usage; exit;;
                    *) pacopts+=("--$OPTARG");;
                esac;;
            # pacaur
            s)  [[ $pacS ]] && operation=search && coweropts+=("-s");
                [[ $pac || $pacQ || $pacS ]] && continue || operation=search; coweropts+=("-s"); aur='1';;
            i)  [[ $pacS ]] && operation=info && coweropts+=("-i");
                [[ $pac || $pacQ || $pacS ]] && continue || operation=info; coweropts+=("-i"); aur='1';;
            d)  [[ $pac || $pacQ || $pacS ]] && continue || operation=download; ((count++));;
            m)  [[ $pac || $pacQ || $pacS ]] && continue || operation=sync; coweropts+=("-f"); aur='1';;
            y)  [[ $pacS ]] && operation=sync && refresh=true;
                [[ $pac || $pacQ || $pacS ]] && continue || operation=sync; installpkg=true; coweropts+=("-f"); aur='1';;
            k)  [[ $pac || $pacQ || $pacS ]] && continue || operation=upgrades; coweropts+=("-u"); aur='1';;
            u)  [[ $pacQ ]] && operation=upgrades && coweropts+=("-u");
                [[ $pacS ]] && operation=sync && upgrade=true && coweropts+=("-f");
                [[ $pac || $pacQ || $pacS ]] && continue || operation=sync; upgrade=true; installpkg=true; coweropts+=("-f"); selective=true; aur='1';;
            f)  [[ $pac || $pacQ || $pacS ]] && continue || coweropts+=("-f");;
            e)  [[ $pacQ ]] && pacopts+=("--explicit") && continue || edit=true;
                [[ ! $operation ]] && operation=editpkg;;
            c)  [[ $pacS ]] && operation=cleancache && ((count++));
                [[ $pac || $pacQ || $pacS ]] && continue || [[ ! $operation ]] && operation=cleanpkg; clean=true && ((count++));;
            q)  quiet=true; pacopts+=("--quiet"); coweropts+=("-q"); coweropts+=("--color=never");;
            # pacman
            r)  repo='1';;
            a)  aur='1';;
            Q)  pacQ='1';;
            S)  pacS='1'; operation=sync; coweropts+=("-f");
                [[ "${opts[@]}" =~ "w" ]] && continue || installpkg=true;
                [[ "${opts[@]}" =~ "g" || "${opts[@]}" =~ "l" || "${opts[@]}" =~ "p" ]] && unset operation;;
            [A-Z]) pac='1';;
            # others
            h)  [[ "${opts[@]}" =~ ^-[A-Z] ]] && unset operation && continue || usage; exit;;
            v)  [[ "${opts[@]}" =~ ^-[A-Z] ]] && unset operation && continue || version; exit;;
            *)  continue;;
        esac
    done

    # packages
    [[ -z "${!OPTIND}" ]] && break || pkgs+=("${!OPTIND}")
    shift $OPTIND
    OPTIND=1
done

pacmanarg=(${pacmanarg[@]/--/})
pacmanarg=(${pacmanarg[@]/-r/})
[[ $pacS ]] && pacmanarg=(${pacmanarg[@]/-e/})

# sanity check
[[ ! $editor ]] && [[ ! -f /usr/bin/vi ]] && msg "e" "The ${colorW}editor${reset} variable is not set.\nCheck configuration in $configdir/config"
[[ ! -f /usr/bin/$pacmanbin ]] && msg "e" "The binary ${colorW}$pacmanbin${reset} is not installed.\nCheck configuration in $configdir/config"
[[ ! -w "$builddir" ]] && msg "e" "You do not have write permission to build packages in ${colorW}$builddir${reset}."
[[ -z "${pkgs[@]}" ]] && [[ $operation = download || $operation = sync || $operation = editpkg || ($operation = cleanpkg && $count -eq 1) ]] && [[ ! $refresh && ! $upgrade ]] && msg "e" "no targets specified (use -h for help)"
[[ $repo && $aur ]] && msg "e" "target not found"

# operations
case $operation in
    download)
        # download (-d) handling
        aurpkgs+=("${pkgs[@]}") && DownloadPkgs
        EditPkgs ${deps[@]}
        exit;;
    cleanpkg)
        # clean (-c) handling
        CleanUp ${pkgs[@]}
        exit;;
    editpkg)
        # edit (-e) handling
        EditPkgs ${pkgs[@]}
        exit;;
    search)
        # search (-Ss, -s) handling
        [[ ! $aur ]] && $pacmanbin ${pacmanarg[@]} ${pacopts[@]} ${ignoreopts[@]} ${pkgs[@]}
        [[ ! $repo ]] && [[ $fallback = true || $aur ]] && SearchInfoAur ${pkgs[@]}
        exit;;
    info)
        # info (-Si, -i) handling
        [[ -z "${pkgs[@]}" ]] && $pacmanbin ${pacmanarg[@]} ${pacopts[@]} ${ignoreopts[@]} || ClassifyPkgs ${pkgs[@]}
        [[ -n "${repopkgs[@]}" ]] && $pacmanbin ${pacmanarg[@]} ${pacopts[@]} ${ignoreopts[@]} ${repopkgs[@]}
        if [[ -n "${aurpkgs[@]}" ]]; then
            [[ $fallback = true && ! $aur ]] && msg "w" "Package(s) ${colorW}${aurpkgs[*]}${reset} not found in repositories, trying ${colorM}AUR${reset}..."
            SearchInfoAur ${aurpkgs[@]}
        fi
        exit;;
    sync)
        # sync (-S, -y), downloadonly (-Sw, -m), refresh (-Sy), sysupgrade (-Su, -u) handling
        if [[ ! $upgrade ]]; then
            [[ -z "${pkgs[@]}" ]] && sudo $pacmanbin ${pacmanarg[@]} ${pacopts[@]} ${ignoreopts[@]} || ClassifyPkgs ${pkgs[@]}
            [[ -n "${repopkgs[@]}" ]] && sudo $pacmanbin ${pacmanarg[@]} ${pacopts[@]} ${ignoreopts[@]} ${repopkgs[@]}
            if [[ -n "${aurpkgs[@]}" ]]; then
                [[ $refresh ]] && [[ -z "${repopkgs[@]}" ]] && sudo $pacmanbin -Sy ${pacopts[@]} ${ignoreopts[@]}
                [[ $fallback = true && ! $aur ]] && msg "w" "Package(s) ${colorW}${aurpkgs[*]}${reset} not found in repositories, trying ${colorM}AUR${reset}..."
                Core ${aurpkgs[@]}
            fi
        else
            [[ ! $selective ]] && ClassifyPkgs ${pkgs[@]} && unset pkgs # selective upgrade switch
            [[ ! $aur ]] && sudo $pacmanbin ${pacmanarg[@]} ${pacopts[@]} ${ignoreopts[@]} ${repopkgs[@]}
            [[ -n "${aurpkgs[@]}" ]] && [[ $fallback = true && ! $aur ]] && msg "w" "Package(s) ${colorW}${aurpkgs[*]}${reset} not found in repositories, trying ${colorM}AUR${reset}..."
            [[ ! $repo ]] && [[ $fallback = true || $aur ]] && Core ${aurpkgs[@]}
        fi
        exit;;
    upgrades)
        # upgrades (-Qu, -k) handling
        [[ ! $aur ]] && CheckRepo ${pkgs[@]}
        [[ ! $repo ]] && [[ $fallback = true || $aur ]] && CheckAur ${pkgs[@]}
        exit;;
    cleancache)
        # clean (-Sc) handling
        [[ ! $aur ]] && sudo $pacmanbin ${pacmanarg[@]} ${pacopts[@]} ${ignoreopts[@]} ${repopkgs[@]}
        [[ ! $repo ]] && [[ $fallback = true || $aur ]] && CleanCache ${pkgs[@]}
        exit;;
    *)
        # others operations handling
        if [[ -z "${pkgs[@]}" || -n "$(grep -e "-[QTglp]" <<< ${pacmanarg[@]})" ]]; then
            $pacmanbin ${pacmanarg[@]} ${pacopts[@]} ${ignoreopts[@]} ${pkgs[@]}
        else
            sudo $pacmanbin ${pacmanarg[@]} ${pacopts[@]} ${ignoreopts[@]} ${pkgs[@]}
        fi
        exit;;
esac

# vim:set ts=4 sw=2 et:
